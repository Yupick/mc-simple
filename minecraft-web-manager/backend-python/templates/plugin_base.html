{% extends 'base.html' %}

{% block title %}{{ plugin.name }} — Configuración{% endblock %}

{% block page_scripts %}
    {%- if block('page_scripts') -%}{% endblock %}
{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex items-center gap-3">
      <div class="bg-indigo-100 p-3 rounded-lg">
        <i data-lucide="puzzle" class="w-6 h-6 text-indigo-600"></i>
      </div>
      <div>
        <h2 class="text-2xl font-bold text-gray-900">{{ plugin.name }}</h2>
        <p class="text-sm text-gray-600">Panel de configuración gráfico y editor RAW</p>
      </div>
    </div>
  </div>

  {% block plugin_body %}
  <!-- Editor RAW de archivos de configuración por defecto -->
  <div x-data="rawConfigEditor()" x-init="init()" class="bg-white rounded-lg shadow p-6">
    <h3 class="text-lg font-bold text-gray-900 mb-2">Editor de archivos de configuración</h3>
    <template x-if="files.length === 0">
      <div class="text-gray-500">No se encontraron archivos de configuración para este plugin.</div>
    </template>
    <template x-if="files.length > 0">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="md:col-span-1">
          <label class="text-xs text-gray-500">Archivos</label>
          <select class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm mb-4" @change="openFile($event.target.value)">
            <template x-for="file in files" :key="file">
              <option :value="file" x-text="file" :selected="file === activeFile"></option>
            </template>
          </select>
        </div>
        <div class="md:col-span-3">
          <template x-if="activeFile">
            <div>
              <label class="text-xs text-gray-500">Contenido de <span x-text="activeFile"></span></label>
              <textarea x-model="fileContent" class="w-full border border-gray-300 rounded-lg p-2 font-mono text-xs min-h-[300px] mb-2"></textarea>
              <div class="flex gap-2 mt-2">
                <button @click="saveFile()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">Guardar</button>
                <span x-text="saveMessage" class="text-xs text-gray-500"></span>
              </div>
            </div>
          </template>
        </div>
      </div>
    </template>
  </div>
  <script>
  function rawConfigEditor() {
    return {
      files: [],
      activeFile: '',
      fileContent: '',
      saveMessage: '',
      async init() {
        // Detectar plugin_id y tipo desde variables globales o data-attributes
        const pluginId = '{{ plugin_id|default("") }}';
        const pluginType = '{{ plugin_type|default("") }}';
        if (!pluginId) return;
        // Lógica para obtener archivos de configuración
        let url = '';
        // Ajustar rutas a los endpoints reales en /api/plugins
        if (pluginType === 'mmorpg') {
          url = `/api/plugins/mmorpg/${pluginId}/files`;
        } else {
          url = `/api/plugins/${pluginId}/files`;
        }
        try {
          const res = await fetch(url);
          const data = await res.json();
          this.files = Array.isArray(data) ? data : (data.files || []);
          if (this.files.length > 0) {
            this.activeFile = this.files[0];
            this.openFile(this.activeFile);
          }
        } catch (e) {
          this.files = [];
        }
      },
      async openFile(file) {
        this.activeFile = file;
        if (!file) return;
        const pluginId = '{{ plugin_id|default("") }}';
        const pluginType = '{{ plugin_type|default("") }}';
        let url = '';
        if (pluginType === 'mmorpg') {
          url = `/api/plugins/mmorpg/${pluginId}/files/${encodeURIComponent(file)}`;
        } else {
          url = `/api/plugins/${pluginId}/files/${encodeURIComponent(file)}`;
        }
        try {
          const res = await fetch(url);
          const data = await res.json();
          this.fileContent = data.content || '';
        } catch (e) {
          this.fileContent = '';
        }
      },
      async saveFile() {
        if (!this.activeFile) return;
        const pluginId = '{{ plugin_id|default("") }}';
        const pluginType = '{{ plugin_type|default("") }}';
        let url = '';
        if (pluginType === 'mmorpg') {
          url = `/api/plugins/mmorpg/${pluginId}/files/${encodeURIComponent(this.activeFile)}`;
        } else {
          url = `/api/plugins/${pluginId}/files/${encodeURIComponent(this.activeFile)}`;
        }
        try {
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: this.fileContent })
          });
          const data = await res.json();
          this.saveMessage = data.success ? 'Guardado correctamente' : (data.error || 'Error al guardar');
        } catch (e) {
          this.saveMessage = 'Error al guardar';
        }
        setTimeout(() => { this.saveMessage = ''; }, 2000);
      }
    }
  }
  </script>
  {% endblock %}
</div>
{% endblock %}
