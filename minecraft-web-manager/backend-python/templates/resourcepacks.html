{% extends "base.html" %}

{% block title %}Resource Packs - Minecraft Manager{% endblock %}
{% block page_title %}Resource Pack Manager{% endblock %}
{% block page_description %}Gestionar resource packs con ResourcePackManager{% endblock %}

{% block page_scripts %}
<script src="/static/js/components/resourcepacks.js"></script>
{% endblock %}

{% block content %}
<div x-data="resourcePacksManager()" x-init="init()">
    <!-- Aviso de limitación -->
    <div x-show="status.installed && !status.supportsMultiworld" 
         class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-lg">
        <div class="flex">
            <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-600 mr-3"></i>
            <div>
                <h3 class="text-sm font-medium text-yellow-800">Limitación: No hay soporte multimundo</h3>
                <p class="text-sm text-yellow-700 mt-1">
                    ResourcePackManager fusiona TODOS los packs en un solo pack global. 
                    No se puede asignar un pack diferente por mundo.
                </p>
            </div>
        </div>
    </div>

    <!-- Estado del Plugin -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <span class="text-green-600">●</span>
                    ResourcePackManager
                    <span x-show="status.version" x-text="`v${status.version}`" class="text-sm text-gray-500"></span>
                </h3>
                <p class="text-gray-600 mt-1">Plugin instalado y funcionando</p>
            </div>
            <div class="flex gap-2">
                <button @click="reloadPlugin()"
                        :disabled="loading"
                        class="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition disabled:opacity-50">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                    Recargar
                </button>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white rounded-lg shadow">
        <!-- Tab Headers -->
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                <button @click="activeTab = 'config'" 
                        :class="activeTab === 'config' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition">
                    Configuración
                </button>
                <button @click="activeTab = 'priority'" 
                        :class="activeTab === 'priority' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition">
                    Prioridades
                </button>
                <button @click="activeTab = 'packs'" 
                        :class="activeTab === 'packs' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition">
                    Resource Packs
                </button>
                <button @click="activeTab = 'plugins'" 
                        :class="activeTab === 'plugins' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition">
                    Plugins Compatibles
                </button>
                <button @click="activeTab = 'collisions'" 
                        :class="activeTab === 'collisions' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition">
                    Colisiones
                </button>
                <button @click="activeTab = 'output'" 
                        :class="activeTab === 'output' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition">
                    Pack Final
                </button>
            </nav>
        </div>

        <!-- Tab Contents -->
        <div class="p-6">
            <!-- Configuración Tab -->
            <div x-show="activeTab === 'config'" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                        <div>
                            <h4 class="font-semibold text-gray-900">Auto Host</h4>
                            <p class="text-sm text-gray-600">Alojar automáticamente el pack final</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" x-model="config.autoHost" @change="saveConfig()" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                        <div>
                            <h4 class="font-semibold text-gray-900">Forzar Resource Pack</h4>
                            <p class="text-sm text-gray-600">Obligar a los jugadores a usarlo</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" x-model="config.forceResourcePack" @change="saveConfig()" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mensaje al Jugador</label>
                    <textarea x-model="config.resourcePackPrompt" 
                              @blur="saveConfig()"
                              rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"></textarea>
                    <p class="text-sm text-gray-500 mt-1">Mensaje mostrado cuando el jugador recibe el pack</p>
                </div>
            </div>

            <!-- Prioridades Tab -->
            <div x-show="activeTab === 'priority'" class="space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <p class="text-sm text-blue-800">
                        <strong>Orden de prioridad:</strong> Arrastra para reordenar. Los packs más arriba sobrescriben a los de abajo.
                    </p>
                </div>
                
                <div class="space-y-2">
                    <template x-for="(pack, index) in priority" :key="pack">
                        <div class="flex items-center gap-3 p-3 bg-gray-50 border border-gray-200 rounded-lg hover:shadow-md transition">
                            <div class="flex-shrink-0 bg-primary-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm" 
                                 x-text="index + 1"></div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900" x-text="pack"></p>
                            </div>
                            <div class="flex gap-1">
                                <button @click="movePriority(index, -1)" 
                                        :disabled="index === 0"
                                        class="p-2 text-gray-600 hover:bg-gray-200 rounded disabled:opacity-30 disabled:cursor-not-allowed">
                                    <i data-lucide="arrow-up" class="w-4 h-4"></i>
                                </button>
                                <button @click="movePriority(index, 1)" 
                                        :disabled="index === priority.length - 1"
                                        class="p-2 text-gray-600 hover:bg-gray-200 rounded disabled:opacity-30 disabled:cursor-not-allowed">
                                    <i data-lucide="arrow-down" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </template>
                    
                    <div x-show="priority.length === 0" class="text-center py-8 text-gray-500">
                        No hay packs configurados
                    </div>
                </div>
            </div>

            <!-- Resource Packs Tab -->
            <div x-show="activeTab === 'packs'" class="space-y-4">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-sm text-gray-600">
                        Total: <strong x-text="packs.length"></strong> packs
                    </p>
                    <button @click="openUploadModal()" 
                            class="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                        Subir Pack
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="pack in packs" :key="pack.name">
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-lg transition">
                            <div class="flex items-start justify-between mb-2">
                                <div class="bg-purple-100 p-3 rounded-lg">
                                    <i data-lucide="package" class="w-6 h-6 text-purple-600"></i>
                                </div>
                                <button @click="deletePack(pack.name)" 
                                        class="text-red-600 hover:bg-red-50 p-2 rounded-lg transition">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <h4 class="font-semibold text-gray-900 truncate" x-text="pack.name"></h4>
                            <p class="text-sm text-gray-500" x-text="`${(pack.size / 1024 / 1024).toFixed(2)} MB`"></p>
                            <p class="text-xs text-gray-400 mt-1" x-text="new Date(pack.modified * 1000).toLocaleString('es-ES')"></p>
                        </div>
                    </template>
                    
                    <div x-show="packs.length === 0" class="col-span-full text-center py-12 text-gray-500">
                        No hay resource packs subidos. Usa el botón "Subir Pack" para agregar uno.
                    </div>
                </div>
            </div>

            <!-- Plugins Compatibles Tab -->
            <div x-show="activeTab === 'plugins'" class="space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <p class="text-sm text-blue-800">
                        Plugins que generan automáticamente resource packs detectados por ResourcePackManager
                    </p>
                </div>
                
                <div class="space-y-3">
                    <template x-for="plugin in compatiblePlugins" :key="plugin.name">
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:shadow-md transition">
                            <div class="flex items-center gap-3">
                                <div :class="plugin.enabled ? 'bg-green-100' : 'bg-gray-100'" 
                                     class="w-10 h-10 rounded-lg flex items-center justify-center">
                                    <i data-lucide="plug" :class="plugin.enabled ? 'text-green-600' : 'text-gray-400'" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900" x-text="plugin.name"></h4>
                                    <p class="text-sm text-gray-500" x-text="plugin.enabled ? 'Integrado' : 'Disponible'"></p>
                                </div>
                            </div>
                            <button @click="toggleCompatiblePlugin(plugin.name, !plugin.enabled)" 
                                    :class="plugin.enabled ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-green-600 hover:bg-green-700'"
                                    class="px-4 py-2 text-white rounded-lg transition">
                                <span x-text="plugin.enabled ? 'Deshabilitar' : 'Habilitar'"></span>
                            </button>
                        </div>
                    </template>
                    
                    <div x-show="compatiblePlugins.length === 0" class="text-center py-8 text-gray-500">
                        No se detectaron plugins compatibles instalados
                    </div>
                </div>
            </div>

            <!-- Colisiones Tab -->
            <div x-show="activeTab === 'collisions'" class="space-y-4">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <p class="text-sm text-yellow-800">
                        Log de archivos que colisionan entre diferentes packs. Útil para depuración.
                    </p>
                </div>
                
                <div class="bg-gray-900 text-gray-100 rounded-lg p-4 font-mono text-sm max-h-96 overflow-y-auto">
                    <pre x-text="collisionLog || 'No hay colisiones registradas'"></pre>
                </div>
                
                <button @click="loadCollisions()" 
                        class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    Actualizar
                </button>
            </div>

            <!-- Pack Final Tab -->
            <div x-show="activeTab === 'output'" class="space-y-4">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <p class="text-sm text-green-800">
                        Pack final fusionado que se enviará a los jugadores
                    </p>
                </div>
                
                <div x-show="output.exists" class="border border-gray-200 rounded-lg p-6">
                    <div class="flex items-start gap-4">
                        <div class="bg-green-100 p-4 rounded-lg">
                            <i data-lucide="archive" class="w-8 h-8 text-green-600"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-lg font-bold text-gray-900 mb-2">ResourcePackManager_RSP.zip</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p class="text-gray-500">Tamaño</p>
                                    <p class="font-semibold text-gray-900" x-text="`${(output.size / 1024 / 1024).toFixed(2)} MB`"></p>
                                </div>
                                <div>
                                    <p class="text-gray-500">Última modificación</p>
                                    <p class="font-semibold text-gray-900" x-text="new Date(output.modified * 1000).toLocaleString('es-ES')"></p>
                                </div>
                                <div class="col-span-2">
                                    <p class="text-gray-500">SHA-1 Hash</p>
                                    <p class="font-mono text-xs text-gray-700 break-all" x-text="output.sha1"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div x-show="!output.exists" class="text-center py-12 text-gray-500">
                    No hay pack final generado aún. Sube packs y recarga el plugin.
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Upload -->
    <div x-show="uploadModal.open" 
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         @click.self="closeUploadModal()">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900">Subir Resource Pack</h3>
                <button @click="closeUploadModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Seleccionar archivo .zip
                </label>
                <input type="file" 
                       accept=".zip"
                       @change="handleFileSelect($event)"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                <p class="text-xs text-gray-500 mt-1">Tamaño máximo: 100 MB</p>
            </div>
            
            <div x-show="uploadModal.file" class="mb-4 p-3 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-700">
                    <strong>Archivo seleccionado:</strong><br>
                    <span x-text="uploadModal.file?.name"></span>
                    (<span x-text="uploadModal.file ? (uploadModal.file.size / 1024 / 1024).toFixed(2) : '0'"></span> MB)
                </p>
            </div>
            
            <div x-show="uploadModal.uploading" class="mb-4">
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                         :style="`width: ${uploadModal.progress}%`"></div>
                </div>
                <p class="text-sm text-gray-600 mt-2 text-center" x-text="`${uploadModal.progress}%`"></p>
            </div>
            
            <div class="flex gap-3">
                <button @click="closeUploadModal()" 
                        :disabled="uploadModal.uploading"
                        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition disabled:opacity-50">
                    Cancelar
                </button>
                <button @click="uploadPack()" 
                        :disabled="!uploadModal.file || uploadModal.uploading"
                        class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition disabled:opacity-50">
                    Subir
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/components/resourcepacks.js"></script>
{% endblock %}
